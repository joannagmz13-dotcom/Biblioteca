{% extends "base.html" %}
{% load static %}

{% block content %}

<!-- Estilos personalizados -->
<link rel="stylesheet" href="{% static 'css/base/coloresCustom.css' %}">
<link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css">

<div>
    <span class="fw-bold text-dark">Gestión de Multas</span>
    <span class="mx-2 text-dark">|</span>
    <span class="text-secondary">Multas del Préstamo #{{ prestamo.id_prestamo }}</span>
</div>

<div class="custom-card mt-3">

    <!-- Información del préstamo -->
    <div class="mb-3">
        <p class="mb-1"><b>Alumno:</b> {{ prestamo.alumno.nombre }} {{ prestamo.alumno.apellidos }}</p>
        <p class="mb-1"><b>Libro:</b> {{ prestamo.ejemplar.libro.titulo }}</p>
        <p class="mb-3"><b>Ejemplar:</b> #{{ prestamo.ejemplar.num_ejemplar }}</p>
    </div>

    <!-- Botón agregar multa -->
    <div class="text-end mb-3">
        <button class="btn btn-custom-warning btn-add"
                onclick="agregarMulta({{ prestamo.id_prestamo }})">
            <i class="bi bi-plus-circle"></i> Agregar Multa
        </button>
    </div>

    <!-- Tabla de multas -->
    {% if multas %}
    <div class="table-responsive">
        <table id="multasTable" class="table table-striped table-bordered align-middle">
            <thead>
                <tr>
                    <th>Monto</th>
                    <th>Motivo</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody>
                {% for m in multas %}
                <tr>
                    <td>${{ m.monto }}</td>
                    <td>{{ m.motivo|default:"Sin motivo" }}</td>
                    <td>{{ m.fecha }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% else %}
    <div class="alert alert-info text-center mb-0">
        <i class="bi bi-info-circle"></i> Este préstamo no tiene multas registradas.
    </div>
    {% endif %}

</div>

<!-- Botón volver -->
<div class="text-start mt-3">
    <a href="{% url 'prestamo_list' %}" class="btn btn-custom-secondary">
        <i class="bi bi-arrow-left-circle"></i> Volver
    </a>
</div>


<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script>
    // Activar DataTable
    $(document).ready(function () {
        $('#multasTable').DataTable({
            language: {
                "emptyTable": "No hay multas registradas",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ multas",
                "infoEmpty": "Mostrando 0 a 0 de 0 multas",
                "infoFiltered": "(filtrado de _MAX_ multas totales)",
                "lengthMenu": "Mostrar _MENU_ multas",
                "loadingRecords": "Cargando...",
                "processing": "Procesando...",
                "search": "Buscar:",
                "zeroRecords": "No se encontraron multas",
                "paginate": {
                    "first": '<i class="bi bi-rewind-fill"></i>',
                    "last": '<i class="bi bi-fast-forward-fill"></i>',
                    "next": '<i class="bi bi-caret-right-fill"></i>',
                    "previous": '<i class="bi bi-caret-left-fill"></i>'
                }
            },
            responsive: true
        });
    });
</script>



<!-- Modal agregar multa -->
<script>
function agregarMulta(id) {

    Swal.fire({
        title: "Nueva multa",
        html: `
            <input id="monto" type="number" class="form-control mb-2" placeholder="Monto">
            <input id="motivo" class="form-control mb-2" placeholder="Motivo">
            <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="danado">
                <label class="form-check-label">Marcar ejemplar como dañado</label>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: "Guardar",
        cancelButtonText: "Cancelar",
        confirmButtonColor: "var(--warning-color)",
        cancelButtonColor: "var(--secondary-color)",
        preConfirm: () => ({
            monto: document.getElementById("monto").value,
            motivo: document.getElementById("motivo").value,
            danado: document.getElementById("danado").checked
        })
    }).then(res => {

        if (!res.isConfirmed) return;

        fetch(`/biblioteca/prestamos/multa/manual/${id}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify(res.value)
        })
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                Swal.fire("Listo", "Multa añadida", "success")
                    .then(() => location.reload());
            }
        });

    });

}
</script>

{% endblock %}
